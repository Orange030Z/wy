name: Auto Update Nodes
on:
  schedule:
    - cron: '0 */6 * * *' # 每 6 小时自动运行一次
  workflow_dispatch:      # 允许你手动点击按钮运行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # 必须开启写入权限，否则无法更新 main 分支
    steps:
      - name: 1. 检出源码分支
        uses: actions/checkout@v4
        with:
          ref: source     # 明确告诉它去 source 分支拿 main.py

      - name: 2. 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. 安装脚本依赖
        run: pip install requests PyYAML

      - name: 4. 运行全量抓取脚本
        run: python main.py

      - name: 5. 推送结果到 main 分支
        run: |
          mkdir -p out
          # 拷贝生成的订阅文件到输出目录
          cp clash.yaml sub.txt nodes.txt out/ || true
          cd out
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "自动更新: $(date +'%Y-%m-%d %H:%M')"
          # 核心步骤：将当前结果强制推送到 main 分支，覆盖旧内容
          git push --force "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
